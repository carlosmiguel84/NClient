name: Test .NET Core project

inputs:
  target-framework:
    description: 'Target .NET Core'
    required: true
  solution:
    description: 'Solution/project path'
    required: true
  github_token:
    description: 'GITHUB_TOKEN'
    required: true
  gist_token:
    description: 'GIST_TOKEN'
    required: true
    
outputs:
  test-status:
    description: 'Test status'
    value: ${{ steps.test-run.outputs.test-status }}
    
description: Action for test-core

runs:
  using: "composite"
  steps:
    - name: Set the required target .NET Core version
      run: |
        if [[ "${{ inputs.target-framework }}" == "netcoreapp3.1" ]]; then
          echo "dotnet-version=3.1.x" >> $GITHUB_ENV
        elif [[ "${{ inputs.target-framework }}" == "net5.0" ]]; then
          echo "dotnet-version=5.0.x" >> $GITHUB_ENV
        elif [[ "${{ inputs.target-framework }}" == "net6.0" ]]; then
          echo "dotnet-version=6.0.x" >> $GITHUB_ENV
        else
          echo "dotnet-version=5.0.x" >> $GITHUB_ENV
        fi
      shell: bash
    - name: Setup .NET Core ${{ env.dotnet-version }}
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: ${{ env.dotnet-version }}
    - name: Download build artifacts
      uses: actions/download-artifact@v2
      with:
        name: build-artifacts-${{ inputs.target-framework }}
    - name: Extract build artifacts
      run: tar -xvzf build-artifacts-${{ inputs.target-framework }}.tar.gz
      shell: bash
    - name: Test with ${{ inputs.target-framework }}
      id: test-run
      run: (dotnet test ${{ inputs.solution }} --logger trx --results-directory ./TestResults --framework ${{ inputs.target-framework }} --no-build --verbosity normal --configuration Release && echo "::set-output name=test-status::0") || echo "::set-output name=test-status::1"
      shell: bash
    - name: Check on failures
      if: steps.test-run.outputs.test-status == 1
      run: exit 1
      shell: bash